<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>PDSME – Gestione Offerte</title>
<style>
body { font-family: Arial; margin: 30px; background:#f5f5f5 }
h1 { margin-bottom: 5px }
input, button { padding: 6px; margin: 4px }
.box { background:#fff; padding:15px; margin-bottom:20px; border-radius:6px }
table { width:100%; border-collapse: collapse }
td, th { border-bottom:1px solid #ccc; padding:6px }
</style>
</head>
<body>

<h1>Mini Gestionale Offerte – PDSME</h1>

<div class="box">
<h3>Nuovo Preventivo</h3>
<input id="codiceEsterno" placeholder="Codice esterno">
<button onclick="creaPreventivo()">Crea</button>
<p><b>Codice interno:</b> <span id="codiceInterno">—</span></p>
</div>

<div class="box">
<h3>Lotti</h3>
<input id="descrizione" placeholder="Descrizione lotto">
<input id="prezzo" type="number" placeholder="Prezzo">
<input id="pdf" type="file" accept="application/pdf">
<button onclick="aggiungiLotto()">Aggiungi lotto</button>
<ul id="lotti"></ul>
</div>

<script>
<script>
function creaPreventivo() {
  const codice = codiceEsterno.value.trim();
  if (!codice) {
    alert("Inserisci il codice");
    return;
  }

  const quantita = prompt("Quantità:");
  if (quantita === null) return;

  const prezzo = prompt("Prezzo unitario:");
  if (prezzo === null) return;

  const data = new Date().toLocaleDateString("it-IT");

  const tx = db.transaction("preventivi", "readwrite");
  const store = tx.objectStore("preventivi");

  store.getAll().onsuccess = e => {
    const records = e.target.result;
    let record = records.find(r => r.codiceEsterno === codice);

    if (record) {
      const ok = confirm(
        "Codice già presente.\nVuoi aggiungere una nuova offerta allo storico?"
      );
      if (!ok) return;

      record.offerte.push({ quantita, prezzo, data });
      store.put(record);
      mostraPreventivi();
    } else {
      const progressivo = String(records.length + 1).padStart(4, "0") + "-PDSME";

      record = {
        codiceEsterno: codice,
        codiceInterno: progressivo,
        offerte: [{ quantita, prezzo, data }]
      };

      store.add(record);
      mostraPreventivi();
    }
  };
}
</script>
<script>
function mostraPreventivi() {
  const lista = document.getElementById("lotti");
  lista.innerHTML = "";

  const tx = db.transaction("preventivi", "readonly");
  const store = tx.objectStore("preventivi");

  store.getAll().onsuccess = e => {
    e.target.result.forEach(p => {
      const li = document.createElement("li");

      let html = `<b>${p.codiceEsterno}</b> (${p.codiceInterno})<br>`;

      p.offerte.forEach((o, i) => {
        const ultimo = i === p.offerte.length - 1;
        html += `&nbsp;&nbsp;• ${o.quantita} pz – ${o.prezzo} € cad – ${o.data}`;
        if (ultimo) html += " <b>← ultima offerta</b>";
        html += "<br>";
      });

      li.innerHTML = html;
      lista.appendChild(li);
    });
  };
}
</script>


</body>
</html>

